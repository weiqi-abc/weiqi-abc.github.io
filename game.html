<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é—¯å…³ä¸­...</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .btn-bool { font-size: 1.2em; padding: 15px 35px; margin: 0 10px; min-width: 100px; font-weight: bold; }
        .btn-yes { background-color: #27ae60; } .btn-no { background-color: #c0392b; }
        .hint-text { font-size: 0.9em; color: #666; margin-bottom: 15px; display: block; }
        .multi-input-row { margin-bottom: 10px; display: flex; align-items: center; justify-content: center; }
        .multi-input-row label { width: 60px; text-align: right; margin-right: 10px; font-weight: bold; }
        .multi-input-row input { width: 60px !important; }
        .score-row { margin-bottom: 15px; display: flex; justify-content: center; gap: 20px; }
        .score-item { text-align: center; }
        .score-item label { display: block; margin-bottom: 5px; font-weight: bold; }
        .score-item input { width: 80px !important; }
    </style>
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?d6ae297c0516ef1d9c8f76bf2abca886";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
</head>
<body>

<div class="container">
    <div class="game-header">
        <button class="secondary" onclick="location.href='index.html'">&lt; é€€å‡º</button>
        <span id="lesson-title">åŠ è½½ä¸­...</span>
        <span id="progress-indicator">1 / 3</span>
    </div>

    <!-- æ¶ˆæ¯æç¤º -->
    <div id="msg-toast" style="position:fixed; bottom:80px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.7); color:white; padding:10px 20px; border-radius:20px; opacity:0; pointer-events:none; transition:opacity 0.3s; z-index:100;"></div>

    <div class="game-area">
        <div id="question-text" class="question-text"></div>
        <div id="board-container">
            <canvas id="go-board"></canvas>
        </div>

        <div class="input-area hidden" id="input-section">
            <input type="number" id="answer-input" placeholder="è¾“å…¥æ•°å­—" inputmode="numeric">
            <button class="btn-primary" onclick="submitInput()">æäº¤</button>
        </div>
        <div class="input-area hidden" id="bool-section">
            <button class="btn-primary btn-bool btn-yes" onclick="submitBool(true)">æ˜¯</button>
            <button class="btn-primary btn-bool btn-no" onclick="submitBool(false)">å¦</button>
        </div>
        <div class="input-area hidden" id="select-section">
            <span id="select-hint" class="hint-text"></span>
            <button class="btn-primary" onclick="submitSelection()">ç¡®è®¤æ ‡è®°</button>
        </div>
        <div class="input-area hidden" id="multi-input-section">
            <div class="multi-input-row"><label>è§’ä¸Š:</label><input type="number" id="input-corner">ä¸ª</div>
            <div class="multi-input-row"><label>è¾¹ä¸Š:</label><input type="number" id="input-side">ä¸ª</div>
            <div class="multi-input-row"><label>ä¸­è…¹:</label><input type="number" id="input-center">ä¸ª</div>
            <button class="btn-primary" onclick="submitMultiInput()">æäº¤ç­”æ¡ˆ</button>
        </div>
        <div class="input-area hidden" id="score-section">
            <div class="score-row">
                <div class="score-item"><label>âš« é»‘æ£‹</label><input type="number" id="score-black" placeholder="ç›®æ•°"></div>
                <div class="score-item"><label>âšª ç™½æ£‹</label><input type="number" id="score-white" placeholder="ç›®æ•°"></div>
            </div>
            <button class="btn-primary" onclick="submitScore()">æäº¤åˆ¤å†³</button>
        </div>
        <div class="input-area hidden" id="next-section">
            <button class="btn-primary" onclick="nextProblem()">ä¸‹ä¸€é¢˜ &gt;</button>
        </div>
    </div>
</div>

<div id="result-modal" class="modal">
    <div class="modal-content">
        <h2 id="modal-title"></h2>
        <p id="modal-msg"></p>
        <button class="btn-primary" onclick="closeModal()">ç¡®å®š</button>
    </div>
</div>

<script src="data.js"></script>
<script src="problems.js"></script>
<script src="game.js"></script>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const lessonId = parseInt(urlParams.get('lesson')) || 1;
    let problems = [];

    if (ProblemData[lessonId]) {
        const allProblems = JSON.parse(JSON.stringify(ProblemData[lessonId]));
        for (let i = allProblems.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [allProblems[i], allProblems[j]] = [allProblems[j], allProblems[i]];
        }
        problems = allProblems.slice(0, 3);
    } else {
        alert("æœ¬è¯¾é¢˜ç›®å³å°†ä¸Šçº¿ï¼");
        window.location.href = 'index.html';
    }

    let currentIdx = 0;
    let correctCount = 0;
    let board = null;
    let stepIndex = 0;
    let solutionPath = [];

    document.getElementById('lesson-title').innerText = `ç¬¬${lessonId}è¯¾`;

    setTimeout(() => {
        board = new GoBoard('go-board', 9);
        renderProblem();
    }, 100);

    function renderProblem() {
        const p = problems[currentIdx];
        document.getElementById('progress-indicator').innerText = `${currentIdx + 1} / ${problems.length}`;
        document.getElementById('question-text').innerText = p.desc;
        
        ['input-section', 'bool-section', 'select-section', 'multi-input-section', 'score-section', 'next-section'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });

        // 1. è§£æ SGF
        if (p.sgf) {
            const parsed = board.parseSGF(p.sgf);
            p.initial = parsed.initial;
            if (!p.answer && parsed.answer.length > 0) p.answer = parsed.answer;
            if (!p.size) p.size = parsed.size || 9; 
        }

        // 2. åˆå§‹åŒ–æ£‹ç›˜
        board.setSize(p.size || 9);
        board.setup(p.initial, p.markers || []);

        // 3. å‡†å¤‡ç­”æ¡ˆè·¯å¾„ (å®‰å…¨å¤„ç†)
        if (p.answer) {
            solutionPath = Array.isArray(p.answer) ? p.answer : [p.answer];
        } else {
            solutionPath = []; // é˜²æ­¢æŠ¥é”™
        }
        stepIndex = 0;

        // 4. æ¨¡å¼é…ç½®
        if (p.type === 'board') {
            board.isLocked = false;
            board.setSelectionMode(false);
            // é»˜è®¤é»‘å…ˆï¼Œæˆ–è€…æ ¹æ® SGF ç¬¬ä¸€æ‰‹é¢œè‰²å†³å®š
            board.currentColor = solutionPath.length > 0 ? solutionPath[0].c : 1; 
            
            board.onMove = function(move) {
                // å¦‚æœæ²¡æœ‰ç­”æ¡ˆæ•°æ®ï¼Œç›´æ¥è§†ä¸ºé”™è¯¯æˆ–è€…æç¤º
                if (solutionPath.length === 0) {
                    console.error("No answer defined for this problem!");
                    return;
                }

                const expected = solutionPath[stepIndex];
                
                // æ ¡éªŒ
                if (move.x === expected.x && move.y === expected.y) {
                    stepIndex++;
                    
                    if (stepIndex >= solutionPath.length) {
                        correctCount++;
                        showModal("å›ç­”æ­£ç¡®! ğŸ‰", p.successMsg || "å¥½æ£‹ï¼", true);
                    } else {
                        // ç”µè„‘åº”æ‰‹
                        board.isLocked = true; 
                        setTimeout(() => {
                            const aiMove = solutionPath[stepIndex];
                            board.playMove(aiMove.x, aiMove.y, aiMove.c);
                            stepIndex++;
                            
                            if (stepIndex >= solutionPath.length) {
                                correctCount++;
                                showModal("å›ç­”æ­£ç¡®! ğŸ‰", p.successMsg || "å¥½æ£‹ï¼", true);
                            } else {
                                board.isLocked = false;
                            }
                        }, 500);
                    }
                } else {
                    showModal("å›ç­”é”™è¯¯ ğŸ˜…", "è¿™æ‰‹æ£‹å¥½åƒä¸å¯¹å“¦ã€‚", false);
                    setTimeout(() => {
                        board.setup(p.initial, p.markers||[]);
                        stepIndex = 0;
                        board.currentColor = solutionPath[0].c;
                    }, 1000);
                }
            };
        } 
        else if (p.type === 'bool') {
            document.getElementById('bool-section').classList.remove('hidden');
            board.isLocked = true;
            board.setSelectionMode(false);
        }
        else if (p.type === 'input') {
            document.getElementById('input-section').classList.remove('hidden');
            document.getElementById('answer-input').value = '';
            board.isLocked = true;
        }
        else if (p.type === 'select' || p.type === 'select_point') {
            document.getElementById('select-section').classList.remove('hidden');
            let hint = p.type === 'select' ? "(ç‚¹å‡»æ£‹å­)" : "(ç‚¹å‡»ç©ºç‚¹)";
            document.getElementById('select-hint').innerText = hint;
            board.setSelectionMode(true, p.type === 'select' ? 'stone' : 'point');
        }
        else if (p.type === 'multi_input') {
            document.getElementById('multi-input-section').classList.remove('hidden');
            document.getElementById('input-corner').value = '';
            document.getElementById('input-side').value = '';
            document.getElementById('input-center').value = '';
            board.isLocked = true;
        }
        else if (p.type === 'score_count') {
            document.getElementById('score-section').classList.remove('hidden');
            document.getElementById('score-black').value = '';
            document.getElementById('score-white').value = '';
            board.isLocked = true;
        }
    }

    function submitInput() {
        const val = parseInt(document.getElementById('answer-input').value);
        checkResult(val === problems[currentIdx].answer);
    }
    function submitBool(val) {
        checkResult(val === problems[currentIdx].answer);
    }
    function submitSelection() {
        const p = problems[currentIdx];
        const userSet = board.selectedPoints;
        const ansArr = p.answer || [];
        let isCorrect = (userSet.size === ansArr.length);
        if (isCorrect) {
            for (let point of ansArr) {
                if (!userSet.has(`${point.x},${point.y}`)) { isCorrect = false; break; }
            }
        }
        checkResult(isCorrect);
    }
    function submitMultiInput() {
        const p = problems[currentIdx];
        const v1 = parseInt(document.getElementById('input-corner').value);
        const v2 = parseInt(document.getElementById('input-side').value);
        const v3 = parseInt(document.getElementById('input-center').value);
        checkResult(v1===p.answer[0] && v2===p.answer[1] && v3===p.answer[2]);
    }
    function submitScore() {
        const p = problems[currentIdx];
        const b = parseInt(document.getElementById('score-black').value);
        const w = parseInt(document.getElementById('score-white').value);
        checkResult(b===p.answer.black && w===p.answer.white);
    }

    function checkResult(isCorrect) {
        const p = problems[currentIdx];
        if (isCorrect) {
            correctCount++;
            showModal("å›ç­”æ­£ç¡®! ğŸ‰", p.successMsg || "å¾ˆæ£’ï¼", true);
        } else {
            let msg = "è¯·å†æ€è€ƒä¸€ä¸‹ã€‚";
            if (p.type === 'bool') msg = `æ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š${p.answer ? 'æ˜¯' : 'å¦'}`;
            showModal("å›ç­”é”™è¯¯ ğŸ˜…", msg, true);
        }
    }

    function showModal(title, msg, isNextStep) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-msg').innerText = msg;
        document.getElementById('result-modal').style.display = 'flex';
        window.nextAction = isNextStep ? 'next' : 'retry';
    }

    function closeModal() {
        document.getElementById('result-modal').style.display = 'none';
        if (window.nextAction === 'next') {
            const p = problems[currentIdx];
            if (['board', 'multi_input', 'score_count'].includes(p.type)) {
                board.isLocked = true;
                ['input-section','bool-section','select-section','multi-input-section','score-section'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById('next-section').classList.remove('hidden');
            } else {
                nextProblem();
            }
        }
    }

    function nextProblem() {
        currentIdx++;
        if (currentIdx < problems.length) renderProblem();
        else finishLesson();
    }

    function finishLesson() {
        const score = Math.round((correctCount / problems.length) * 100);
        DataManager.saveScore(lessonId, score);
        
        let title = score >= 60 ? "é—¯å…³æˆåŠŸï¼âœ…" : "ç»§ç»­åŠ æ²¹ï¼ğŸ’ª";
        if (score === 100) title = "å®Œç¾é€šå…³ï¼ğŸ†";
        
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-msg').innerText = `æœ¬è½®å¾—åˆ†ï¼š${score}`;
        const btn = document.querySelector('#result-modal button');
        btn.innerText = "è¿”å›åˆ—è¡¨";
        btn.onclick = () => window.location.href = 'index.html';
        document.getElementById('result-modal').style.display = 'flex';
    }
</script>

</body>

</html>
