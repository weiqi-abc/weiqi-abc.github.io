<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é—¯å…³ä¸­...</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .btn-bool {
            font-size: 1.2em;
            padding: 15px 35px;
            margin: 0 10px;
            min-width: 100px;
            font-weight: bold;
        }
        .btn-yes { background-color: #27ae60; }
        .btn-no { background-color: #c0392b; }
        .hint-text { font-size: 0.9em; color: #666; margin-bottom: 15px; display: block; }
        
        /* ç¬¬15è¯¾ï¼šå¤šé¡¹å¡«ç©ºæ ·å¼ */
        .multi-input-row { margin-bottom: 10px; display: flex; align-items: center; justify-content: center; }
        .multi-input-row label { width: 60px; text-align: right; margin-right: 10px; font-weight: bold; }
        .multi-input-row input { width: 60px !important; }

        /* ç¬¬25è¯¾ï¼šæ¯”åˆ†å¡«ç©ºæ ·å¼ */
        .score-row { margin-bottom: 15px; display: flex; justify-content: center; gap: 20px; }
        .score-item { text-align: center; }
        .score-item label { display: block; margin-bottom: 5px; font-weight: bold; }
        .score-item input { width: 80px !important; }
    </style>
</head>
<body>

<div class="container">
    <div class="game-header">
        <button class="secondary" onclick="location.href='index.html'">&lt; é€€å‡º</button>
        <span id="lesson-title">åŠ è½½ä¸­...</span>
        <span id="progress-indicator">1 / 3</span>
    </div>

    <div class="game-area">
        <div id="question-text" class="question-text"></div>

        <div id="board-container">
            <canvas id="go-board"></canvas>
        </div>

        <!-- 1. å•æ•°å­—è¾“å…¥ -->
        <div class="input-area hidden" id="input-section">
            <input type="number" id="answer-input" placeholder="è¾“å…¥æ•°å­—" inputmode="numeric">
            <button class="btn-primary" onclick="submitInput()">æäº¤</button>
        </div>
        
        <!-- 2. æ˜¯éåˆ¤æ–­ -->
        <div class="input-area hidden" id="bool-section">
            <button class="btn-primary btn-bool btn-yes" onclick="submitBool(true)">æ˜¯</button>
            <button class="btn-primary btn-bool btn-no" onclick="submitBool(false)">å¦</button>
        </div>

        <!-- 3. é€‰æ‹©ç¡®è®¤ (é€‰å­/é€‰æ°”) -->
        <div class="input-area hidden" id="select-section">
            <span id="select-hint" class="hint-text"></span>
            <button class="btn-primary" onclick="submitSelection()">ç¡®è®¤æ ‡è®°</button>
        </div>

        <!-- 4. å¤šé¡¹å¡«ç©º -->
        <div class="input-area hidden" id="multi-input-section">
            <div class="multi-input-row"><label>è§’ä¸Š:</label><input type="number" id="input-corner">ä¸ª</div>
            <div class="multi-input-row"><label>è¾¹ä¸Š:</label><input type="number" id="input-side">ä¸ª</div>
            <div class="multi-input-row"><label>ä¸­è…¹:</label><input type="number" id="input-center">ä¸ª</div>
            <button class="btn-primary" onclick="submitMultiInput()">æäº¤ç­”æ¡ˆ</button>
        </div>

        <!-- 5. èƒœè´Ÿåˆ¤æ–­ -->
        <div class="input-area hidden" id="score-section">
            <div class="score-row">
                <div class="score-item"><label>âš« é»‘æ£‹</label><input type="number" id="score-black" placeholder="ç›®æ•°"></div>
                <div class="score-item"><label>âšª ç™½æ£‹</label><input type="number" id="score-white" placeholder="ç›®æ•°"></div>
            </div>
            <p style="font-size:0.8em; color:#888; margin-bottom:10px;">(è¾“å…¥åŒæ–¹å é¢†çš„äº¤å‰ç‚¹æ•°é‡)</p>
            <button class="btn-primary" onclick="submitScore()">æäº¤åˆ¤å†³</button>
        </div>

        <!-- 6. ä¸‹ä¸€é¢˜ (é»˜è®¤éšè—ï¼Œåªæœ‰Boardç±»é¢˜ç›®åšå®Œåæ‰æ˜¾ç¤º) -->
        <div class="input-area hidden" id="next-section">
            <button class="btn-primary" onclick="nextProblem()">ä¸‹ä¸€é¢˜ &gt;</button>
        </div>
    </div>
</div>

<div id="result-modal" class="modal">
    <div class="modal-content">
        <h2 id="modal-title"></h2>
        <p id="modal-msg"></p>
        <button class="btn-primary" onclick="closeModal()">ç¡®å®š</button>
    </div>
</div>

<script src="data.js"></script>
<script src="problems.js"></script>
<script src="game.js"></script>

<script>
    // --- åˆå§‹åŒ– ---
    const urlParams = new URLSearchParams(window.location.search);
    const lessonId = parseInt(urlParams.get('lesson')) || 1;
    let problems = [];

    // éšæœºé€‰é¢˜é€»è¾‘
    if (ProblemData[lessonId]) {
        const allProblems = JSON.parse(JSON.stringify(ProblemData[lessonId]));
        for (let i = allProblems.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [allProblems[i], allProblems[j]] = [allProblems[j], allProblems[i]];
        }
        problems = allProblems.slice(0, 3);
    } else {
        alert("æœ¬è¯¾é¢˜ç›®å³å°†ä¸Šçº¿ï¼");
        window.location.href = 'index.html';
    }

    let currentIdx = 0;
    let correctCount = 0;
    let board = null;

    document.getElementById('lesson-title').innerText = `ç¬¬${lessonId}è¯¾`;

    setTimeout(() => {
        board = new GoBoard('go-board', 9);
        renderProblem();
    }, 100);

    // --- æ¸²æŸ“é€»è¾‘ ---
    function renderProblem() {
        const p = problems[currentIdx];
        document.getElementById('progress-indicator').innerText = `${currentIdx + 1} / ${problems.length}`;
        document.getElementById('question-text').innerText = p.desc;
        
        // éšè—æ‰€æœ‰äº¤äº’åŒº
        ['input-section', 'bool-section', 'select-section', 'multi-input-section', 'score-section', 'next-section'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });

        // SGF è§£æ
        if (p.sgf) {
            const parsed = board.parseSGF(p.sgf);
            p.initial = parsed.initial;
            if (!p.answer && parsed.answer) p.answer = parsed.answer;
            if (!p.size) p.size = parsed.size || 9; 
        }

        board.setSize(p.size || 9);
        board.setup(p.initial, p.markers || []);

        // æ¨¡å¼é…ç½®
        if (p.type === 'board') {
            board.isLocked = false;
            board.setSelectionMode(false);
            board.currentColor = 1;
            board.onMove = function(move) {
                if (move.x === p.answer.x && move.y === p.answer.y) {
                    correctCount++;
                    // ç­”å¯¹åï¼Œæš‚ä¸é‡ç½®æ£‹ç›˜ï¼Œè®©ç”¨æˆ·çœ‹ä¸€çœ¼
                    showModal("å›ç­”æ­£ç¡®! ğŸ‰", p.successMsg || "å¥½æ£‹ï¼", true);
                } else {
                    showModal("å›ç­”é”™è¯¯ ğŸ˜…", "è¿™æ‰‹æ£‹å¥½åƒä¸å¯¹å“¦ã€‚", false);
                    setTimeout(() => board.setup(p.initial, p.markers||[]), 1000);
                }
            };
        } 
        else if (p.type === 'bool') {
            document.getElementById('bool-section').classList.remove('hidden');
            board.isLocked = true;
            board.setSelectionMode(false);
        }
        else if (p.type === 'input') {
            document.getElementById('input-section').classList.remove('hidden');
            document.getElementById('answer-input').value = '';
            board.isLocked = true;
        }
        else if (p.type === 'select' || p.type === 'select_point') {
            document.getElementById('select-section').classList.remove('hidden');
            let hint = p.type === 'select' ? "(ç‚¹å‡»æ£‹å­)" : "(ç‚¹å‡»ç©ºç‚¹)";
            document.getElementById('select-hint').innerText = hint;
            board.setSelectionMode(true, p.type === 'select' ? 'stone' : 'point');
        }
        else if (p.type === 'multi_input') {
            document.getElementById('multi-input-section').classList.remove('hidden');
            document.getElementById('input-corner').value = '';
            document.getElementById('input-side').value = '';
            document.getElementById('input-center').value = '';
            board.isLocked = true;
        }
        else if (p.type === 'score_count') {
            document.getElementById('score-section').classList.remove('hidden');
            document.getElementById('score-black').value = '';
            document.getElementById('score-white').value = '';
            board.isLocked = true;
        }
    }

    // --- æäº¤å‡½æ•° ---
    function submitInput() {
        const val = parseInt(document.getElementById('answer-input').value);
        checkResult(val === problems[currentIdx].answer);
    }
    function submitBool(val) {
        checkResult(val === problems[currentIdx].answer);
    }
    function submitSelection() {
        const p = problems[currentIdx];
        const userSet = board.selectedPoints;
        const ansArr = p.answer;
        let isCorrect = (userSet.size === ansArr.length);
        if (isCorrect) {
            for (let point of ansArr) {
                if (!userSet.has(`${point.x},${point.y}`)) { isCorrect = false; break; }
            }
        }
        checkResult(isCorrect);
    }
    function submitMultiInput() {
        const p = problems[currentIdx];
        const v1 = parseInt(document.getElementById('input-corner').value);
        const v2 = parseInt(document.getElementById('input-side').value);
        const v3 = parseInt(document.getElementById('input-center').value);
        checkResult(v1===p.answer[0] && v2===p.answer[1] && v3===p.answer[2]);
    }
    function submitScore() {
        const p = problems[currentIdx];
        const b = parseInt(document.getElementById('score-black').value);
        const w = parseInt(document.getElementById('score-white').value);
        checkResult(b===p.answer.black && w===p.answer.white);
    }

    function checkResult(isCorrect) {
        const p = problems[currentIdx];
        if (isCorrect) {
            correctCount++;
            showModal("å›ç­”æ­£ç¡®! ğŸ‰", p.successMsg || "å¾ˆæ£’ï¼", true);
        } else {
            let msg = "è¯·å†æ€è€ƒä¸€ä¸‹ã€‚";
            if (p.type === 'bool') msg = `æ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š${p.answer ? 'æ˜¯' : 'å¦'}`;
            showModal("å›ç­”é”™è¯¯ ğŸ˜…", msg, true);
        }
    }

    // --- å¼¹çª—ä¸è·³è½¬é€»è¾‘ (æ ¸å¿ƒä¿®æ”¹) ---
    function showModal(title, msg, isNextStep) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-msg').innerText = msg;
        document.getElementById('result-modal').style.display = 'flex';
        window.nextAction = isNextStep ? 'next' : 'retry';
    }

    function closeModal() {
        document.getElementById('result-modal').style.display = 'none';
        
        if (window.nextAction === 'next') {
            const p = problems[currentIdx];
            
            // å®šä¹‰å“ªäº›ç±»å‹éœ€è¦â€œæ‰‹åŠ¨ç‚¹å‡»ä¸‹ä¸€é¢˜â€ (ä»¥ä¾¿æŸ¥çœ‹æ£‹ç›˜çŠ¶æ€)
            // board: è½å­åæ£‹å½¢å˜åŒ–ï¼Œéœ€è¦çœ‹
            // multi_input / score_count: å¤æ‚é¢˜ï¼Œå¯èƒ½æƒ³å›é¡¾
            const manualAdvanceTypes = ['board', 'multi_input', 'score_count'];

            if (manualAdvanceTypes.includes(p.type)) {
                // 1. æ‰‹åŠ¨æ¨¡å¼ï¼šåœç•™åœ¨å½“å‰é¡µï¼Œæ˜¾ç¤ºä¸‹ä¸€é¢˜æŒ‰é’®
                board.isLocked = true; // é”ä½æ£‹ç›˜é˜²æ­¢ä¹±ç‚¹
                
                // éšè—æ‰€æœ‰äº¤äº’æ¡†
                ['input-section','bool-section','select-section','multi-input-section','score-section'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                
                // æ˜¾ç¤ºä¸‹ä¸€é¢˜æŒ‰é’®
                document.getElementById('next-section').classList.remove('hidden');
                
            } else {
                // 2. è‡ªåŠ¨æ¨¡å¼ï¼šç›´æ¥è·³ä¸‹ä¸€é¢˜ (Bool, Select, Input)
                nextProblem();
            }
        }
    }

    function nextProblem() {
        currentIdx++;
        if (currentIdx < problems.length) {
            renderProblem();
        } else {
            finishLesson();
        }
    }

    function finishLesson() {
        const score = Math.round((correctCount / problems.length) * 100);
        DataManager.saveScore(lessonId, score);
        
        let title = score >= 60 ? "é—¯å…³æˆåŠŸï¼âœ…" : "ç»§ç»­åŠ æ²¹ï¼ğŸ’ª";
        if (score === 100) title = "å®Œç¾é€šå…³ï¼ğŸ†";
        
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-msg').innerText = `æœ¬è½®å¾—åˆ†ï¼š${score}`;
        const btn = document.querySelector('#result-modal button');
        btn.innerText = "è¿”å›åˆ—è¡¨";
        btn.onclick = () => window.location.href = 'index.html';
        
        document.getElementById('result-modal').style.display = 'flex';
    }
</script>

</body>
</html>